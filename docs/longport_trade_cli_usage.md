# LongPort 交易账户查询 CLI 使用说明

## 概述

`longport_trade_cli.py` 是一个命令行工具，用于查询和计算 LongPort 交易账户的各项指标，包括总资产净值、持仓市值、现金余额、账户盈亏等，并支持多币种折算展示。

## 功能特性

- ✅ 计算账户总资产净值（多币种折算）
- ✅ 查询各币种现金余额
- ✅ 查询股票持仓明细及实时市值
- ✅ 计算持仓盈亏
- ✅ 支持资金调整（如未入账资金）
- ✅ 显示杠杆率和账户总盈亏
- ✅ 输出格式化的文本报告
- ✅ 同时保存 JSON 格式数据
- ✅ 详细的日志记录

## 使用方法

### 计算账户指标 (account-metrics)

```bash
# 使用默认参数查询（币种：CNH，初始资金：1000000）
python tasks/longport_trade_cli.py account-metrics

# 指定目标币种为美元
python tasks/longport_trade_cli.py account-metrics --currency USD

# 指定目标币种为港币
python tasks/longport_trade_cli.py account-metrics --currency HKD

# 自定义初始资金
python tasks/longport_trade_cli.py account-metrics --initial-capital 2000000

# 添加资金调整（如有未入账资金）
python tasks/longport_trade_cli.py account-metrics --adjust USD 2000

# 添加多个资金调整
python tasks/longport_trade_cli.py account-metrics --adjust USD 2000 --adjust HKD -1000

# 完整示例：指定币种、初始资金和调整金额
python tasks/longport_trade_cli.py account-metrics --currency CNH --initial-capital 1000000 --adjust USD 5000
```

**参数说明：**

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `--currency` | 字符串 | CNH | 目标币种，所有资产将折算为此币种 (USD/HKD/CNH) |
| `--initial-capital` | 浮点数 | 1000000.0 | 初始资金，用于计算账户总盈亏 |
| `--adjust` | 币种 金额 | 无 | 资金调整，可多次使用。用于处理未入账或需要额外调整的资金 |

**输出内容包括：**

- **汇率信息**：各币种对目标币种的汇率
- **账户概览**：
  - 总资产净值（持仓市值 + 现金余额 + 调整金额）
  - 现金余额合计
  - 持仓总市值
  - 资金调整合计
  - 杠杆率
  - 账户盈亏（金额和百分比）
- **资金调整明细**：各币种调整金额及折算值
- **持仓明细**：
  - 股票代码和名称
  - 持仓数量
  - 原始币种
  - 成本价和现价
  - 市值（原币种和折算值）
  - 持仓盈亏

## 输出文件

所有查询结果会自动保存到 `caches/account/` 目录下：

- **文本格式**: `account_metrics_{YYYYMMDD}.txt` - 易读的格式化文本
- **JSON格式**: `account_metrics_{YYYYMMDD}.json` - 结构化数据，便于程序处理

例如：
- `caches/account/account_metrics_20241207.txt`
- `caches/account/account_metrics_20241207.json`

## 日志文件

运行日志保存在 `logs/` 目录下：

- 文件名格式: `longport_trade_cli_YYYY-MM-DD.log`
- 日志轮转: 每天一个新文件
- 保留时间: 30天

## 环境配置

使用前需确保已配置 LongPort API 环境变量：

```bash
export LONGPORT_APP_KEY="your_app_key"
export LONGPORT_APP_SECRET="your_app_secret"
export LONGPORT_ACCESS_TOKEN="your_access_token"
```

## 示例输出

### 账户指标查询示例

```
================================================================================
账户指标信息
================================================================================
查询时间: 2024-12-07 14:30:25
展示币种: CNH
初始资金: ¥1,800,000.00

【汇率信息】
--------------------------------------------------------------------------------
  1 USD = 7.2500 CNH
  1 HKD = 0.9300 CNH

【账户概览】
--------------------------------------------------------------------------------
  总资产净值:     ¥1,925,678.50
  现金余额合计:   ¥425,678.50
  持仓总市值:     ¥1,500,000.00
  杠杆率:         77.92%
  账户盈亏:       +¥125,678.50 (6.98%)

【持仓明细】
--------------------------------------------------------------------------------
  AAPL.US (苹果)
    持仓数量:     100 股
    原始币种:     USD
    成本价:       $175.50
    现价:         $195.00
    市值:         $19,500.00 (¥141,375.00)
    持仓盈亏:     +$1,950.00 (+¥14,137.50)

  700.HK (腾讯控股)
    持仓数量:     200 股
    原始币种:     HKD
    成本价:       HK$320.00
    现价:         HK$380.00
    市值:         HK$76,000.00 (¥70,680.00)
    持仓盈亏:     +HK$12,000.00 (+¥11,160.00)

================================================================================
```

### 带资金调整的示例

```bash
python tasks/longport_trade_cli.py account-metrics --adjust USD 5000 --adjust HKD -2000
```

输出：
```
================================================================================
账户指标信息
================================================================================
查询时间: 2024-12-07 14:35:00
展示币种: CNH
初始资金: ¥1,800,000.00

【汇率信息】
--------------------------------------------------------------------------------
  1 USD = 7.2500 CNH
  1 HKD = 0.9300 CNH

【账户概览】
--------------------------------------------------------------------------------
  总资产净值:     ¥1,959,390.50
  现金余额合计:   ¥425,678.50
  持仓总市值:     ¥1,500,000.00
  资金调整合计:   ¥33,712.00
  杠杆率:         76.56%
  账户盈亏:       +¥159,390.50 (8.85%)

【资金调整明细】
--------------------------------------------------------------------------------
  USD: +$5,000.00 (¥36,250.00)
  HKD: -HK$2,000.00 (-¥1,860.00)

...
================================================================================
```

## 常见问题

### Q: 如何选择目标币种？

A: 使用 `--currency` 参数指定目标币种。所有资产（包括不同币种的现金和持仓）都会按当前汇率折算到该币种展示：
```bash
python tasks/longport_trade_cli.py account-metrics --currency USD
```

### Q: 什么情况下需要使用资金调整？

A: 当您有以下情况时可以使用 `--adjust` 参数：
- 已转入但尚未到账的资金
- 需要从统计中排除的资金
- 其他需要手动调整的金额

### Q: 为什么有些股票显示"现价: 无数据"？

A: 这通常是因为：
- 股票在非交易时段，无法获取实时报价
- 股票代码错误或已退市
- API 请求频率限制

### Q: 杠杆率是如何计算的？

A: 杠杆率 = 持仓总市值 / 总资产净值

### Q: 输出文件在哪里？

A: 所有输出文件保存在项目根目录下的 `caches/account/` 文件夹中，按日期命名。

## 技术细节

- **Python版本**: Python 3.7+
- **依赖库**: 
  - loguru: 日志记录
  - longport: LongPort OpenAPI SDK
- **日志级别**: INFO
- **编码格式**: UTF-8

## 与其他工具的区别

| 工具 | 用途 | 消息推送 | 行情数据 | 交易日判断 |
|------|------|---------|---------|-----------|
| `run_messager.py` | 定时推送账户报告 | ✅ | ✅ | ✅ |
| `longport_trade_cli.py` | 命令行账户指标查询 | ❌ | ✅ | ❌ |
| `longport_quota_cli.py` | 行情数据收集工具 | ❌ | ✅ | ❌ |

`longport_trade_cli.py` 专注于提供账户资产计算和展示功能，支持多币种折算和资金调整。
